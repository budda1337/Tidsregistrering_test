@page
@model RegistreringerModel
@{
    ViewData["Title"] = "Mine Registreringer";
}

<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="bi bi-list-ul"></i> Mine Registreringer</h2>
            <a href="/" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i> Ny Registrering
            </a>
        </div>
    </div>
</div>

@if (Model.Registreringer.Any())
{
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-table"></i> Alle Registreringer
                        <span class="badge bg-secondary">@Model.Registreringer.Count</span>
                    </h5>
                    <small class="text-muted">
                        Viser registreringer for @Model.FullName
                    </small>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-dark">
                                <tr>
                                    <th><i class="bi bi-hash"></i> ID</th>
                                    <th><i class="bi bi-calendar3"></i> Registreret</th>
                                    <th><i class="bi bi-calendar-check"></i> Arbejde Udført</th>
                                    <th><i class="bi bi-clock"></i> Tid</th>
                                    <th><i class="bi bi-building"></i> Afdeling</th>
                                    <th><i class="bi bi-tag"></i> Sagsnummer</th>
                                    <th><i class="bi bi-chat-left-text"></i> Bemærkninger</th>
                                    <th><i class="bi bi-gear"></i> Handlinger</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var reg in Model.Registreringer)
                                {
                                    <tr>
<td class="fw-bold text-primary">@reg.Id</td>
<td>
    <i class="bi bi-calendar-event"></i>
    @reg.Dato.ToString("dd-MM-yyyy HH:mm")
</td>
<td>
    @if (reg.DatoUdført.HasValue)
    {
        <i class="bi bi-calendar-check text-success"></i>
        @reg.DatoUdført.Value.ToString("dd-MM-yyyy")
    }
    else
    {
        <span class="text-muted">-</span>
    }
</td>
<td>
    @{
        var timer = reg.Minutter / 60;
        var min = reg.Minutter % 60;
    }
    <span class="badge bg-info">
        @if (timer > 0)
        {
            @($"{timer}t {min}m")
        }
        else
        {
            @($"{min}m")
        }
    </span>
    <small class="text-muted">(@reg.Minutter min)</small>
</td>
<td>
    <span class="badge bg-secondary text-wrap" style="max-width: 200px;">
        @reg.Afdeling
    </span>
</td>
<td>
    @if (!string.IsNullOrEmpty(reg.Sagsnummer))
    {
        <span class="badge bg-info">
            <i class="bi bi-tag"></i> @reg.Sagsnummer
        </span>
    }
    else
    {
        <span class="text-muted">-</span>
    }
</td>
<td>
    @if (!string.IsNullOrEmpty(reg.Bemærkninger))
    {
        <div class="text-truncate" style="max-width: 250px;"
             title="@reg.Bemærkninger">
            @reg.Bemærkninger
        </div>
    }
    else
    {
        <em class="text-muted">Ingen bemærkninger</em>
    }
</td>
<td>
    <div class="btn-group btn-group-sm">
        <button type="button" class="btn btn-outline-primary"
                onclick="editRegistrering(@reg.Id)"
                title="Rediger">
            <i class="bi bi-pencil"></i>
        </button>
        <button type="button" class="btn btn-outline-danger"
                onclick="confirmDelete(@reg.Id)"
                title="Slet">
            <i class="bi bi-trash"></i>
        </button>
    </div>
</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Registrering statistikker -->
    <div class="row mt-4">
        <div class="col-md-4">
            <div class="card bg-primary text-white">
                <div class="card-body text-center">
                    <h4>@Model.Registreringer.Count</h4>
                    <p class="mb-0">Registreringer</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    @{
                        var totalMinutter = Model.Registreringer.Sum(r => r.Minutter);
                        var totalTimer = totalMinutter / 60;
                        var totalMin = totalMinutter % 60;
                    }
                    <h4>@totalTimer t @totalMin m</h4>
                    <p class="mb-0">Total Tid</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-info text-white">
                <div class="card-body text-center">
                    @{
                        var afdelinger = Model.Registreringer.Select(r => r.Afdeling).Distinct().Count();
                    }
                    <h4>@afdelinger</h4>
                    <p class="mb-0">Afdelinger</p>
                </div>
            </div>
        </div>
    </div>
}
else
{
    <!-- Ingen registreringer -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body text-center py-5">
                    <i class="bi bi-inbox display-1 text-muted"></i>
                    <h3 class="mt-3">Ingen registreringer endnu</h3>
                    <p class="text-muted">Du har ikke oprettet nogen tidsregistreringer endnu.</p>
                    <a href="/" class="btn btn-primary btn-lg">
                        <i class="bi bi-plus-circle"></i> Opret Din Første Registrering
                    </a>
                </div>
            </div>
        </div>
    </div>
}

<!-- Slet form - skal være udenfor if-blokken -->
<form method="post" asp-page-handler="Delete" style="display: none;" id="deleteForm">
    <input type="hidden" name="id" id="deleteId" />
</form>

<!-- Rediger Modal -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editModalLabel">
                    <i class="bi bi-pencil-square"></i> Rediger Registrering
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" asp-page-handler="Edit" id="editForm">
                <div class="modal-body">
                    <input type="hidden" name="editId" id="editFormId" />
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editDatoUdført" class="form-label">
                                    <i class="bi bi-calendar3"></i> Dato for udført arbejde
                                </label>
                                <input type="date" class="form-control" name="editDatoUdført" id="editDatoUdført" />
                                <small class="form-text text-muted">Valgfrit - hvis ikke angivet bruges registreringsdato</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editMinutter" class="form-label">
                                    <i class="bi bi-clock"></i> Tid brugt (minutter) *
                                </label>
                                <input type="number" class="form-control" name="editMinutter" id="editMinutter" min="1" required />
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="editAfdeling" class="form-label">
                            <i class="bi bi-building"></i> Afdeling *
                        </label>
                        <select class="form-select" name="editAfdeling" id="editAfdeling" required>
                            <option value="">Vælg afdeling...</option>
                            @foreach (var afdeling in Model.Afdelinger)
                            {
                                <option value="@afdeling">@afdeling</option>
                            }
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="editSagsnummer" class="form-label">
                            <i class="bi bi-tag"></i> Sagsnummer
                        </label>
                        <input type="text" class="form-control" name="editSagsnummer" id="editSagsnummer"
                               maxlength="60" placeholder="fx SAG2025-123 (valgfrit)" />
                        <small class="form-text text-muted">Valgfrit - op til 60 tegn</small>
                    </div>

                    <div class="mb-3">
                        <label for="editBemærkninger" class="form-label">
                            <i class="bi bi-chat-left-text"></i> Bemærkninger
                        </label>
                        <textarea class="form-control" name="editBemærkninger" id="editBemærkninger" rows="4" placeholder="Beskrivelse af arbejdet..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> Annuller
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle"></i> Gem Ændringer
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Alle registreringer data til JavaScript (til rediger-funktionen)
        var registreringer = [
            @foreach (var reg in Model.Registreringer)
            {
                        @Html.Raw("{")
                        @Html.Raw($"id: {reg.Id},")
                        @Html.Raw($"minutter: {reg.Minutter},")
                        @Html.Raw($"afdeling: '{Html.Raw(reg.Afdeling.Replace("'", "\\'"))}',")
                        @Html.Raw($"bemærkninger: '{Html.Raw((reg.Bemærkninger ?? "").Replace("'", "\\'").Replace("\n", "\\n"))}',")
                        @Html.Raw($"datoUdført: '{(reg.DatoUdført?.ToString("yyyy-MM-dd") ?? "")}',")
                        @Html.Raw($"sagsnummer: '{Html.Raw((reg.Sagsnummer ?? "").Replace("'", "\\'"))}'")
                        @Html.Raw("},")
            }
        ];

        function confirmDelete(id) {
            if (confirm('Er du sikker på at du vil slette denne registrering?')) {
                console.log('Sletter registrering med ID: ' + id);
                document.getElementById('deleteId').value = id;
                document.getElementById('deleteForm').submit();
            }
        }

        function editRegistrering(id) {
            // Find registreringen i vores data
            var reg = registreringer.find(r => r.id === id);
            if (!reg) {
                alert('Kunne ikke finde registrering!');
                return;
            }

            // Udfyld modal formularen
            document.getElementById('editFormId').value = reg.id;
            document.getElementById('editMinutter').value = reg.minutter;
            document.getElementById('editAfdeling').value = reg.afdeling;
            document.getElementById('editBemærkninger').value = reg.bemærkninger;
            document.getElementById('editDatoUdført').value = reg.datoUdført;
            document.getElementById('editSagsnummer').value = reg.sagsnummer;

            // Vis modal
            var modal = new bootstrap.Modal(document.getElementById('editModal'));
            modal.show();
        }
    </script>
}