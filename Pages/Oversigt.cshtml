@page
@model OversigtModel
@{
    ViewData["Title"] = "Oversigt - Alle Registreringer";
}

<div class="row">
    <div class="col-12">
        <h2><i class="bi bi-table"></i> Oversigt - Alle Registreringer</h2>
        <p class="text-muted">Komplet oversigt over alle tidsregistreringer i systemet</p>
    </div>
</div>

<!-- Detaljer Modal -->
<div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="detailsModalLabel">
                    <i class="bi bi-info-circle"></i> Registrering Detaljer
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modalContent">
                <!-- Content will be loaded here by JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Luk
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Filtrering og søgning -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="bi bi-funnel"></i> Filtrer og Søg
                </h5>
            </div>
            <div class="card-body">
                <form method="get" class="row g-3">
                    <!-- Dato filtre -->
                    <div class="col-md-2">
                        <label asp-for="FraDato" class="form-label">Fra Dato</label>
                        <input asp-for="FraDato" class="form-control" type="date" />
                    </div>
                    <div class="col-md-2">
                        <label asp-for="TilDato" class="form-label">Til Dato</label>
                        <input asp-for="TilDato" class="form-control" type="date" />
                    </div>

                    <!-- Afdeling filtre -->
                    <div class="col-md-2">
                        <label asp-for="ValgtAfdeling" class="form-label">Arbejde udført for</label>
                        <select asp-for="ValgtAfdeling" class="form-select">
                            <option value="">Alle afdelinger</option>
                            @foreach (var afdeling in Model.Afdelinger)
                            {
                                <option value="@afdeling">@afdeling</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label asp-for="ValgtOuAfdeling" class="form-label">Arbejde udført af</label>
                        <select asp-for="ValgtOuAfdeling" class="form-select">
                            <option value="">Alle OU afdelinger</option>
                            @foreach (var ouAfdeling in Model.OuAfdelinger)
                            {
                                <option value="@ouAfdeling">@ouAfdeling</option>
                            }
                        </select>
                    </div>

                    <!-- Medarbejder filter -->
                    <div class="col-md-2">
                        <label asp-for="ValgtBruger" class="form-label">Medarbejder</label>
                        <select asp-for="ValgtBruger" class="form-select">
                            <option value="">Alle medarbejdere</option>
                            @foreach (var bruger in Model.Brugere)
                            {
                                <option value="@bruger">@bruger</option>
                            }
                        </select>
                    </div>

                    <!-- Sagsnummer filter -->
                    <div class="col-md-2">
                        <label asp-for="ValgtSagsnummer" class="form-label">Sagsnummer</label>
                        <input asp-for="ValgtSagsnummer" class="form-control" type="text"
                               placeholder="Søg i sagsnummer..." />
                    </div>

                    <div class="col-12">
                        <button type="submit" class="btn btn-primary me-2">
                            <i class="bi bi-search"></i> Søg
                        </button>
                        <a href="/Oversigt" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-clockwise"></i> Nulstil
                        </a>
                    </div>
                </form>

                @if (Model.FraDato.HasValue || Model.TilDato.HasValue || !string.IsNullOrEmpty(Model.ValgtAfdeling) || !string.IsNullOrEmpty(Model.ValgtBruger) || !string.IsNullOrEmpty(Model.ValgtOuAfdeling) || !string.IsNullOrEmpty(Model.ValgtSagsnummer))
                {
                    <div class="mt-3">
                        <strong>Aktive filtre:</strong>
                        @if (Model.FraDato.HasValue)
                        {
                            <span class="badge bg-secondary me-1">Fra: @Model.FraDato.Value.ToString("dd-MM-yyyy")</span>
                        }
                        @if (Model.TilDato.HasValue)
                        {
                            <span class="badge bg-secondary me-1">Til: @Model.TilDato.Value.ToString("dd-MM-yyyy")</span>
                        }
                        @if (!string.IsNullOrEmpty(Model.ValgtAfdeling))
                        {
                            <span class="badge bg-secondary me-1">Udført for: @Model.ValgtAfdeling</span>
                        }
                        @if (!string.IsNullOrEmpty(Model.ValgtOuAfdeling))
                        {
                            <span class="badge bg-secondary me-1">Udført af: @Model.ValgtOuAfdeling</span>
                        }
                        @if (!string.IsNullOrEmpty(Model.ValgtBruger))
                        {
                            <span class="badge bg-secondary me-1">@Model.ValgtBruger</span>
                        }
                        @if (!string.IsNullOrEmpty(Model.ValgtSagsnummer))
                        {
                            <span class="badge bg-secondary me-1">Sagsnr: @Model.ValgtSagsnummer</span>
                        }
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<!-- Statistik oversigt -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card border-primary">
            <div class="card-body text-center">
                <i class="bi bi-clipboard-data display-4 text-primary"></i>
                <h3 class="mt-2 text-primary">@Model.TotalAntalRegistreringer.ToString("N0")</h3>
                <p class="mb-0 text-muted">Registreringer Fundet</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card border-success">
            <div class="card-body text-center">
                <i class="bi bi-hourglass-split display-4 text-success"></i>
                <h3 class="mt-2 text-success">@Model.TotalTimerDecimal</h3>
                <p class="mb-0 text-muted">Timer Registreret</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card border-info">
            <div class="card-body text-center">
                <i class="bi bi-people display-4 text-info"></i>
                <h3 class="mt-2 text-info">@Model.Brugere.Count</h3>
                <p class="mb-0 text-muted">Unikke Medarbejdere</p>
            </div>
        </div>
    </div>
</div>

<!-- Registreringer tabel -->
@if (Model.AlleRegistreringer.Any())
{
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0">
                            <i class="bi bi-table"></i> Alle Registreringer
                            <span class="badge bg-light text-dark ms-2">@Model.TotalAntalRegistreringer</span>
                        </h5>
                    </div>
                    <div>
                        <small>Sorteret efter: @Model.SortBy (@(Model.SortDescending ? "Faldende" : "Stigende"))</small>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-dark">
                                <tr>
                                    <th>
                                        <a href="@Model.GetSortUrl("Dato")" class="text-white text-decoration-none">
                                            <i class="bi @Model.GetSortIcon("Dato")"></i> Dato
                                        </a>
                                    </th>
                                    <th>
                                        <a href="@Model.GetSortUrl("Bruger")" class="text-white text-decoration-none">
                                            <i class="bi @Model.GetSortIcon("Bruger")"></i> Medarbejder
                                        </a>
                                    </th>
                                    <th>
                                        <a href="@Model.GetSortUrl("Afdeling")" class="text-white text-decoration-none">
                                            <i class="bi @Model.GetSortIcon("Afdeling")"></i> Afdeling
                                        </a>
                                    </th>
                                    <th><i class="bi bi-tag"></i> Sagsnummer</th>
                                    <th>
                                        <a href="@Model.GetSortUrl("Tid")" class="text-white text-decoration-none">
                                            <i class="bi @Model.GetSortIcon("Tid")"></i> Tid
                                        </a>
                                    </th>
                                    <th><i class="bi bi-calendar-check"></i> Arbejde Udført</th>
                                    <th><i class="bi bi-chat-left-text"></i> Bemærkninger</th>
                                    <th><i class="bi bi-info-circle"></i> Detaljer</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var reg in Model.AlleRegistreringer)
                                {
                                    <tr>
                                        <td>
                                            <i class="bi bi-calendar-event text-primary"></i>
                                            <strong>@reg.Dato.ToString("dd-MM-yyyy")</strong>
                                            <br><small class="text-muted">@reg.Dato.ToString("HH:mm")</small>
                                        </td>
                                        <td>
                                            <div>
                                                <strong>@(reg.FuldeNavn ?? "Ukendt")</strong>
                                                <br><small class="text-muted">@reg.Brugernavn</small>
                                                @if (!string.IsNullOrEmpty(reg.OuAfdeling))
                                                {
                                                    <br>
                                        
                                                    <small class="text-info">OU: @reg.OuAfdeling</small>
                                                }
                                            </div>
                                        </td>
                                        <td>
                                            <span class="badge bg-secondary">@reg.Afdeling</span>
                                        </td>
                                        <td>
                                            @if (!string.IsNullOrEmpty(reg.Sagsnummer))
                                            {
                                                <span class="badge bg-info">
                                                    <i class="bi bi-tag"></i> @reg.Sagsnummer
                                                </span>
                                            }
                                            else
                                            {
                                                <span class="text-muted">-</span>
                                            }
                                        </td>
                                        <td>
                                            @{
                                                var timer = reg.Minutter / 60;
                                                var min = reg.Minutter % 60;
                                            }
                                            <span class="badge bg-success fs-6">
                                                @if (timer > 0)
                                                {
                                                    @($"{timer}t {min}m")
                                                }
                                                else
                                                {
                                                    @($"{min}m")
                                                }
                                            </span>
                                            <br><small class="text-muted">(@reg.Minutter min)</small>
                                        </td>
                                        <td>
                                            @if (reg.DatoUdført.HasValue)
                                            {
                                                <i class="bi bi-calendar-check text-success"></i>
                                                @reg.DatoUdført.Value.ToString("dd-MM-yyyy")
                                            }
                                            else
                                            {
                                                <span class="text-muted">Ikke angivet</span>
                                            }
                                        </td>
                                        <td>
                                            @if (!string.IsNullOrEmpty(reg.Bemærkninger))
                                            {
                                                <div class="text-truncate" style="max-width: 200px;"
                                                     title="@reg.Bemærkninger">
                                                    @reg.Bemærkninger
                                                </div>
                                            }
                                            else
                                            {
                                                <em class="text-muted">Ingen bemærkninger</em>
                                            }
                                        </td>
                                        <td>
                                            <small class="text-muted">
                                                ID: @reg.Id<br />
                                                Oprettet: @reg.Oprettet.ToString("dd-MM HH:mm")
                                            </small>
                                            <div class="mt-2">
                                                <button type="button" class="btn btn-outline-info btn-sm"
                                                        onclick="showDetails(@reg.Id)"
                                                        title="Se alle detaljer">
                                                    <i class="bi bi-eye"></i> Se Detaljer
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
}
else
{
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body text-center py-5">
                    <i class="bi bi-search display-1 text-muted"></i>
                    <h3 class="mt-3">Ingen Registreringer Fundet</h3>
                    <p class="text-muted">Prøv at justere dine filter-indstillinger.</p>
                    <a href="/Oversigt" class="btn btn-primary">
                        <i class="bi bi-arrow-clockwise"></i> Vis Alle Registreringer
                    </a>
                </div>
            </div>
        </div>
    </div>
}

<!-- Navigation links -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body text-center">
                <h5>Hurtige Links</h5>
                <div class="btn-group" role="group">
                    <a href="/" class="btn btn-primary">
                        <i class="bi bi-plus-circle"></i> Ny Registrering
                    </a>
                    <a href="/Registreringer" class="btn btn-outline-primary">
                        <i class="bi bi-person-workspace"></i> Mine Registreringer
                    </a>
                    <a href="/Statistik" class="btn btn-outline-primary">
                        <i class="bi bi-bar-chart"></i> Statistik
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Alle registrerings data til JavaScript
        var registreringer = [
            @foreach (var reg in Model.AlleRegistreringer)
            {
                    <text>{</text>
                    <text>id: @reg.Id,</text>
                    <text>dato: '@reg.Dato.ToString("dd-MM-yyyy HH:mm")',</text>
                    <text>minutter: @reg.Minutter,</text>
                    <text>afdeling: '@Html.Raw(reg.Afdeling.Replace("'", "\\'"))',</text>
                    <text>bemærkninger: '@Html.Raw((reg.Bemærkninger ?? "Ingen bemærkninger").Replace("'", "\\'").Replace("\n", "\\n").Replace("\r", ""))',</text>
                    <text>brugernavn: '@Html.Raw(reg.Brugernavn.Replace("'", "\\'"))',</text>
                    <text>fuldeNavn: '@Html.Raw((reg.FuldeNavn ?? "Ukendt").Replace("'", "\\'"))',</text>
                    <text>ouAfdeling: '@Html.Raw((reg.OuAfdeling ?? "").Replace("'", "\\'"))',</text>
                    <text>datoUdført: '@(reg.DatoUdført?.ToString("dd-MM-yyyy") ?? "")',</text>
                    <text>oprettet: '@reg.Oprettet.ToString("dd-MM-yyyy HH:mm")',</text>
                    <text>sagsnummer: '@Html.Raw((reg.Sagsnummer ?? "").Replace("'", "\\'"))'</text>
                    <text>},</text>
            }
        ];

        function showDetails(id) {
            // Find registreringen
            var reg = registreringer.find(r => r.id === id);
            if (!reg) {
                alert('Kunne ikke finde registrering!');
                return;
            }

            // Beregn timer og minutter
            var timer = Math.floor(reg.minutter / 60);
            var restMinutter = reg.minutter % 60;
            var tidTekst = timer > 0 ? `${timer}t ${restMinutter}m` : `${restMinutter}m`;

            // Byg HTML indhold
            var content = `
                <div class="row">
                    <div class="col-md-6">
                        <div class="card border-primary mb-3">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0"><i class="bi bi-person"></i> Medarbejder Information</h6>
                            </div>
                            <div class="card-body">
                                <p><strong>Navn:</strong> ${reg.fuldeNavn}</p>
                                <p><strong>Brugernavn:</strong> ${reg.brugernavn}</p>
                                ${reg.ouAfdeling ? `<p><strong>OU Afdeling:</strong> ${reg.ouAfdeling}</p>` : ''}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card border-success mb-3">
                            <div class="card-header bg-success text-white">
                                <h6 class="mb-0"><i class="bi bi-clock"></i> Tid Information</h6>
                            </div>
                            <div class="card-body">
                                <p><strong>Registreret tid:</strong> <span class="badge bg-info fs-6">${tidTekst}</span></p>
                                <p><strong>Total minutter:</strong> ${reg.minutter}</p>
                                <p><strong>Afdeling:</strong> <span class="badge bg-secondary">${reg.afdeling}</span></p>
                                ${reg.sagsnummer ? `<p><strong>Sagsnummer:</strong> <span class="badge bg-info"><i class="bi bi-tag"></i> ${reg.sagsnummer}</span></p>` : ''}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="card border-warning mb-3">
                            <div class="card-header bg-warning text-dark">
                                <h6 class="mb-0"><i class="bi bi-calendar"></i> Dato Information</h6>
                            </div>
                            <div class="card-body">
                                <p><strong>Registrerings dato:</strong> ${reg.dato}</p>
                                <p><strong>Arbejde udført dato:</strong> ${reg.datoUdført || 'Ikke angivet'}</p>
                                <p><strong>Oprettet:</strong> ${reg.oprettet}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card border-info mb-3">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0"><i class="bi bi-info-circle"></i> System Information</h6>
                            </div>
                            <div class="card-body">
                                <p><strong>Registrering ID:</strong> #${reg.id}</p>
                                <p><strong>Status:</strong> <span class="badge bg-success">Aktiv</span></p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-12">
                        <div class="card border-secondary">
                            <div class="card-header bg-secondary text-white">
                                <h6 class="mb-0"><i class="bi bi-chat-left-text"></i> Bemærkninger</h6>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-light" style="white-space: pre-wrap; max-height: 200px; overflow-y: auto;">
                                    ${reg.bemærkninger}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Vis modal
            document.getElementById('modalContent').innerHTML = content;
            document.getElementById('detailsModalLabel').innerHTML = `
                <i class="bi bi-info-circle"></i> Registrering #${reg.id} - ${reg.fuldeNavn}
            `;

            var modal = new bootstrap.Modal(document.getElementById('detailsModal'));
            modal.show();
        }
    </script>
}